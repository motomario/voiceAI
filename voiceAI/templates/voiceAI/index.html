<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voice Assistant</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
<h1>Voice Assistant Interface</h1>
<button id="start-listening">Start Listening</button>
<button id="stop-listening" style="display:none;">Stop Listening</button>
<div id="transcription"></div>

<script>
    // CSRF Token setup for AJAX requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Web Speech API setup
    if ('webkitSpeechRecognition' in window) {
        var recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onstart = function() {
            document.getElementById('start-listening').style.display = 'none';
            document.getElementById('stop-listening').style.display = 'inline';
            console.log('Voice recognition started. Speak into the microphone.');
        };

        recognition.onerror = function(event) {
            console.log('Voice recognition error occurred:', event.error);
        };

        recognition.onend = function() {
            document.getElementById('start-listening').style.display = 'inline';
            document.getElementById('stop-listening').style.display = 'none';
            console.log('Voice recognition ended.');
        };

        recognition.onresult = function(event) {
            var transcript = '';
            for (var i = event.resultIndex; i < event.results.length; ++i) {
                transcript += event.results[i][0].transcript;
            }
            $('#transcription').text(transcript); // Display the transcript on the page
            // Process the transcript by sending it to the Django backend
            $.ajax({
                url: '/voiceAI/process_command/', // URL to your Django view
                type: 'POST',
                data: {
                    'transcript': transcript,
                    'csrfmiddlewaretoken': csrftoken // Include the CSRF token
                },
                success: function(response) {
                    // Log the response to the console
                    console.log('Server response:', response);
                    // Update the transcription div with the AI response
                    $('#transcription').text(response.message);
                },
                error: function(xhr, status, error) {
                    console.error('AJAX error:', status, error);
                }
            });
        };

        document.getElementById('start-listening').addEventListener('click', function() {
            recognition.start();
        });

        document.getElementById('stop-listening').addEventListener('click', function() {
            recognition.stop();
        });

    } else {
        console.log('Your browser does not support the Web Speech API');
    }
</script>
</body>
</html>
